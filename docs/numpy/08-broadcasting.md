# 广播机制

> 对应代码: [08_broadcasting.py](file:///d:/Nayey/Code/NayukiChiba/Machine-Learning-Algorithms/Basic/Numpy/08_broadcasting.py)

## 学习目标

- 理解 NumPy 的广播机制
- 掌握广播的规则和原理
- 学会利用广播进行高效运算

## 什么是广播

NumPy 在进行不同形状数组运算时，会自动"广播"较小的数组，使其与较大数组形状兼容。

## 广播规则

1. **从后向前**比较每个维度的大小
2. 维度大小**相同**或其中一个为 **1** 时可以广播
3. **缺失的维度**视为 1

### 广播示例

```
数组 A: (3, 4)    数组 B: (4,)     → 结果: (3, 4)  ✓
数组 A: (3, 4)    数组 B: (3, 1)   → 结果: (3, 4)  ✓
数组 A: (3, 1)    数组 B: (1, 4)   → 结果: (3, 4)  ✓
数组 A: (3, 4)    数组 B: (3,)     → 错误！无法广播 ✗
```

## 标量与数组广播

```python
arr = np.array([[1, 2, 3], [4, 5, 6], [7, 8, 9]])

# 标量会广播到所有元素
arr + 10
# [[11, 12, 13],
#  [14, 15, 16],
#  [17, 18, 19]]

arr * 2
# [[ 2,  4,  6],
#  [ 8, 10, 12],
#  [14, 16, 18]]
```

## 一维与二维数组广播

```python
arr_2d = np.array([[1, 2, 3], [4, 5, 6], [7, 8, 9]])  # (3, 3)
arr_1d = np.array([10, 20, 30])                       # (3,)

# 一维数组按行广播
arr_2d + arr_1d
# [[11, 22, 33],
#  [14, 25, 36],
#  [17, 28, 39]]
```

## 列向量广播

```python
arr_2d = np.array([[1, 2, 3], [4, 5, 6], [7, 8, 9]])  # (3, 3)
col = np.array([[100], [200], [300]])                 # (3, 1)

# 列向量按列广播
arr_2d + col
# [[101, 102, 103],
#  [204, 205, 206],
#  [307, 308, 309]]
```

## 广播可视化

```
数组 A (3, 3):         数组 B (3,):
[[1, 2, 3],            [10, 20, 30]
 [4, 5, 6],                ↓ 广播
 [7, 8, 9]]            [[10, 20, 30],
                        [10, 20, 30],
                        [10, 20, 30]]
```

## 利用广播实现外积

```python
a = np.array([1, 2, 3])      # (3,)
b = np.array([10, 20, 30, 40]) # (4,)

# 方法 1: 利用广播
outer = a[:, np.newaxis] * b
# [[ 10,  20,  30,  40],
#  [ 20,  40,  60,  80],
#  [ 30,  60,  90, 120]]

# 方法 2: 使用 np.outer
np.outer(a, b)  # 结果相同
```

## 实际应用：数据标准化

```python
# 原始数据 (5 个样本, 3 个特征)
data = np.random.randint(0, 100, size=(5, 3))

# 计算每列的均值和标准差
mean = data.mean(axis=0)  # (3,)
std = data.std(axis=0)    # (3,)

# 标准化（利用广播）
normalized = (data - mean) / std

# 验证
print(normalized.mean(axis=0))  # 接近 0
print(normalized.std(axis=0))   # 接近 1
```

## 广播的优势

- ✅ 避免创建大型临时数组
- ✅ 代码更简洁
- ✅ 运算更高效
- ✅ 内存更节省

## 常见错误

```python
A = np.ones((3, 4))
B = np.ones((3,))    # 形状 (3,) 而非 (4,)

A + B  # 错误！(4,) 和 (3,) 不兼容
```

> [!CAUTION]
> 当最后一个维度不匹配且都不为 1 时，无法广播。

## 练习

运行代码文件查看完整演示：

```bash
python Basic/Numpy/08_broadcasting.py
```
